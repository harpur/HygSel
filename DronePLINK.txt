###
#Associations with PLINK

#Make PED FIles
vcftools --vcf DroneSelectionFinal.recode.vcf --plink --out DroneSelection
	#OOPS, get rid of 18.1 and 17.2000 + 
	test=read.table(file="DroneSelection.map",header=F)
	snps1=test$V2[grep("^18.1:*",test$V2)]
	snps2=test$V2[grep("^17.[2-9][0-9][0-9][0-9]:*",test$V2)]
	snps=c(as.character(snps1),as.character(snps2))
	write.table(snps,file="ExcludedSNPs",col.names=F,row.names=F,quote=F)
plink --file DroneSelection --exclude ExcludedSNPs --noweb --make-bed
plink --bfile plink  --recode --out DroneSelectionEx  --noweb




##Specifics on Phenotype Files:
#Made an "alternate pheno file" called /media/data1/forty3/drone/vcf_drone/DronePhenoHB.txt 
#also made "AllPheno.txt", this will allow me to test ALL phenotypes at once with the --all-pheno flag
#HB indicates hygienic behaviour. Using this, I can specify phenotypes not coded in the .ped file
#http://pngu.mgh.harvard.edu/~purcell/plink/data.shtml

plink --file DroneSelection --pheno DronePhenoHB.txt  --noweb --assoc --allow-no-sex --adjust
#all Phenos, writes out a file for each pheno association AND pheno means at each SNP. Does FDR for me.
plink --file DroneSelection --all-pheno --pheno AllPheno.txt  --noweb --assoc --allow-no-sex --adjust --qt-means
#12:49 start time. Finish at 13:41.
#In R, below, I took the median expresison data for all HB traits (expression of the 7 proteins), made AllHBPheno.txt and re-ran
plink --file DroneSelection --all-pheno --pheno AllHBPheno.txt  --noweb --assoc --allow-no-sex --adjust --qt-means

#and this one, with PCAs
plink --file DroneSelection --all-pheno --pheno PCAPheno.txt  --noweb --assoc --allow-no-sex --adjust --qt-means


#Need to correct for stratification:
#I'm using the "within" command and HBCatPheno.txt
plink --file DroneSelection --all-pheno --pheno HBCatPheno.txt  --noweb --mh --allow-no-sex --within Cluster2.txt --adjust 

DroneSelectionFinal.recode.vcf


###After DroneEIG

plink --file DroneSelection --mpheno 1 --maf 0.1 --mind 0.2 --pheno DronePhenoHB.txt --noweb --allow-no-sex --linear  --covar HBPCA.txt
	R
	as=read.table(file="plink.assoc.linear",header=T)
	as=as[which(as$TEST=="ADD" & !is.na(as$P)),]
	source("/media/data1/forty3/brock/scripts/qq.r")
	#pdf("associationLDSNPsCV.pdf")
	qq(as$P)
	#dev.off()



#ASSOCIATION BASED ON TD Candidates
1)

vcftools --vcf DroneSelection.vcf  --maf 0.05 --max-missing 0.2 --positions GenicFstP3.snp --plink --out DroneCandidateHL

plink --file DroneCandidateHL --mpheno 1 --pheno DronePhenoHB.txt --noweb --allow-no-sex --linear --adjust  --out HLCandidate --keep controlBees.txt

cands=read.table(file="Candidate.assoc.linear",header=T)
source("/media/data1/forty3/brock/scripts/manhattan.r")
results=results[!is.na(results$P),]
manhattan(results)


lmm=read.table(file="/media/data1/forty3/drone/FaSTLMM.207.Linux/Linux_MKL/CandidateCV.insample.txt",header=T)
results=lmm[,c(1,2,4,5)];names(results)=c("SNP", "CHR", "BP", "P")
results$BP=as.numeric(as.character(results$BP));results$CHR=as.numeric(as.character(results$CHR))
results=results[!is.na(results$P),]
manhattan(results)


#Get intersection set for both methods:
snps=intersect(lmm$SNP, plink$SNP)





#Assosciation BAsed on High Fst Genes:

plink --file DroneSelection --noweb --allow-no-sex  --out HLCandidateCAT  --extract GenicHighestFSTSNPs.snp --keep controlBees.txt --mpheno 1 --pheno DronePhenoHB.txt --assoc --adjust --qt-means

	#THIS might do it:	
plink --file DroneSelection --noweb --allow-no-sex  --out HLCandidateperm100k --extract GenicHighestFSTSNPs.snp  --mpheno 1 --pheno DronePhenoHB.txt --assoc --mperm 100000 #--keep controlBees.txt
	R
	source("/media/data1/forty3/brock/scripts/qq.r")
	snps=read.table(file="HLCandidateperm100k.qassoc.mperm",header=T)
	x11();qq(snps$EMP2)
		#after 100000 perms, no change in shape of curve. 
	
	
#how about random SNPs? 	
	shuf -n 300 GenicHighestFSTSNPs.snp > output
	plink --file DroneSelection --noweb --allow-no-sex  --out output100k --extract output  --mpheno 1 --pheno DronePhenoHB.txt --assoc --mperm 100000
	
	

	snps=read.table(file="output100k.qassoc.mperm",header=T)
	x11();qq(snps$EMP2)
	
	
	
	
	#In summary: Permutation is not controlling effectively for stratification and I can't get out significance with the control bees alone (because of fixations, probably).
	
	

	
	
	
	###THIS WORKS:
plink --file DroneSelection --mpheno 1 --pheno DronePhenoHB.txt --extract GenicHighestFSTSNPsRAND.snp --noweb --allow-no-sex --linear  --covar HBPCA.txt --adjust --vif 100
	source("/media/data1/forty3/brock/scripts/qq.r")
	snps=read.table(file="plink.assoc.linear.adjusted",header=T)
	x11();qq(snps$UNADJ)
	
	plink --file DroneSelection --mpheno 1 --pheno DronePhenoHB.txt --extract GenicHighestFSTSNPsRAND.snp --noweb --allow-no-sex --linear --adjust --out noCoVar 
	
	UNsnps=read.table(file="noCoVar.assoc.linear.adjusted",header=T)
	x11();qq(UNsnps$UNADJ)
	
for K in {1..1000}
do
	shuf -n 10 GenicHighestFSTSNPsRAND.snp > output$K
	plink --file DroneSelection --mpheno 1 --pheno DronePhenoHB.txt --extract output$K --noweb --allow-no-sex --linear  --covar HBPCA.txt --adjust --out RAND$K
done

	
	
	
	
	
	
	
	
	
	
	
	
	
	
#Again, with 216 random SNPs too	
	map=read.table(file="DroneSelection.map")
	map=map[sample(nrow(map),300),]
	write.table(map$V2,file="GenicHighestFSTSNPsRAND.snp",quote=F,row.names=F,col.names=F)
	#Copied in candidates
plink --file DroneSelection --noweb --allow-no-sex  --out HLRANDperm10000k --extract GenicHighestFSTSNPsRAND.snp  --mpheno 1 --pheno DronePhenoHB.txt --assoc --mperm 10000000
	R
	snps=read.table(file="HLRANDperm10000k.qassoc.mperm",header=T)
	x11();qq(snps$EMP2)
	
	#Similar to: http://www.plosgenetics.org/article/info%3Adoi%2F10.1371%2Fjournal.pgen.1002316#s4
	
	
	
	
--extract GenicHighestFSTSNPs.snp 


plink --file DroneSelection --noweb --allow-no-sex --out HLCandidateLIN  --extract GenicHighestFSTSNPs.snp --keep controlBees.txt --mpheno 1 --pheno DronePhenoHB.txt --linear --adjust

plink --file DroneSelection --noweb --allow-no-sex --out ControlCandidatehighFST  --extract GenicHighestFSTSNPs.snp --keep controlBees.txt --mpheno 1 --pheno DronePhenoHB.txt --assoc --qt-means

plink --file DroneSelection --noweb --allow-no-sex --out ControlWholeGenome  --keep controlBees.txt --mpheno 1 --pheno DronePhenoHB.txt --linear --adjust



#RAN THESE:
	plink --file DroneSelection --noweb --allow-no-sex --out ExpressionCandidate  --extract GenicHighestFSTSNPs21.snp --pheno HBexpression.txt --all-pheno --linear --adjust --keep controlBees.txt 

	plink --file DroneSelection --noweb --allow-no-sex --out HLCandidate  --extract GenicHighestFSTSNPs.snp  --mpheno 1 --pheno DronePhenoHB.txt --assoc --qt-means


	
	
	
#RAN THESE for expression QTLs:
	plink --file DroneSelection --noweb --allow-no-sex --out HLCandidate  --extract GenicHighestFSTSNPs.snp --mpheno 1 --pheno DronePhenoHB.txt --linear --adjust #--keep controlBees.txt 

	plink --file DroneSelection --noweb --allow-no-sex --out HLCandidate  --extract GenicHighestFSTSNPs.snp  --mpheno 1 --pheno DronePhenoHB.txt --assoc --qt-means

	


#####################
##
#Linear
plink --file DroneSelection --mpheno 1 --pheno AllHBPheno.txt --noweb --allow-no-sex --linear  --covar HBPCA.txt --adjust --vif 100
plink --file DroneSelection --mpheno 1 --pheno AllHBPheno.txt --covar-number 1 --noweb --allow-no-sex --linear  --covar HBPCA.txt --adjust --vif 100


	#With a linked file:

	plink --file DroneSelectionFinalLinked --mpheno 1 --pheno AllHBPheno.txt --noweb --allow-no-sex --linear  --covar HBPCA.txt --adjust --vif 100 --out DRONELINKED
						
						as=read.table(file="DRONELINKED.assoc.linear",header=T)
						as=as[which(as$TEST=="ADD" & !is.na(as$P)),]
						source("/media/data1/forty3/brock/scripts/qq.r")
						pdf("associationLDSNPsCV.pdf")
						qq(as$P)
						dev.off()
							
		plink --file Excluded17s --mpheno 1 --pheno AllHBPheno.txt --noweb --allow-no-sex --linear  --covar HBPCA.txt --adjust --vif 100 --out DRONE17
	
						as=read.table(file="DRONELINKED.assoc.linear",header=T)
						as=as[which(as$TEST=="ADD" & !is.na(as$P)),]
						source("/media/data1/forty3/brock/scripts/qq.r")
						pdf("associationSNPsCV17s.pdf")
						qq(as$P)
						dev.off()
	
	
	
		plink --file Excluded17s --mpheno 1 --pheno AllHBPheno.txt --noweb --allow-no-sex --linear  --out DRONE17nCV
						R
						as=read.table(file="DRONE17nCV.assoc.linear",header=T)
						as=as[which(as$TEST=="ADD" & !is.na(as$P)),]
						source("/media/data1/forty3/brock/scripts/qq.r")
						pdf("associationSNPsnCV17s.pdf")
						qq(as$P)
						dev.off()
	
	as=as[which(!is.na(as$P)),]
	
	

#Full Set
plink --file DroneSelection --mpheno 1 --pheno DronePhenoHB.txt --noweb --allow-no-sex --linear  --covar HBPCA.txt --adjust --out DRONEFULL
grep ADD DRONEFULL.assoc.linear > DRONEFULL.assoc.linearADD




#On specific chromos
plink --file DroneSelection --maf 0.1 --recode --make-bed --noweb --mind 0.1 --chr 2 --out CleandDroneCHR2
plink --file DroneSelection --maf 0.1 --recode --make-bed --noweb --mind 0.1 --chr 5 --out CleandDroneCHR5
plink --file DroneSelection --maf 0.1 --recode --make-bed --noweb --mind 0.1 --chr 16 --out CleandDroneCHR16
plink --file DroneSelection --maf 0.1 --recode --make-bed --noweb --mind 0.1 --chr 9 --out CleandDroneCHR9
plink --file DroneSelection --maf 0.1 --recode --make-bed --noweb --mind 0.1 --chr 10 --out CleandDroneCHR10

plink --bfile CleandDroneCHR2 --mpheno 1 --pheno /media/data1/forty3/drone/vcf_drone/DronePhenoHB.txt  --noweb --allow-no-sex --assoc --adjust --out CHR2
plink --bfile CleandDroneCHR5 --mpheno 1 --pheno /media/data1/forty3/drone/vcf_drone/DronePhenoHB.txt  --noweb --allow-no-sex --assoc --adjust --out CHR5
plink --bfile CleandDroneCHR16 --mpheno 1 --pheno /media/data1/forty3/drone/vcf_drone/DronePhenoHB.txt  --noweb --allow-no-sex --assoc --adjust --out CHR16
plink --bfile CleandDroneCHR9 --mpheno 1 --pheno /media/data1/forty3/drone/vcf_drone/DronePhenoHB.txt  --noweb --allow-no-sex --assoc --adjust --out CHR9
plink --bfile CleandDroneCHR10 --mpheno 1 --pheno /media/data1/forty3/drone/vcf_drone/DronePhenoHB.txt  --noweb --allow-no-sex --assoc --adjust --out CHR10

R
as=read.table(file="CHR9.qassoc",header=T) #9
as=as[which(!is.na(as$P)),]
source("/media/data1/forty3/brock/scripts/qq.r")
qq(as$P)


#Runs of Homoz 
plink --file DroneSelection --maf 0.1  --noweb --mind 0.1 --homozyg








#Full Set - on population cluster
plink --file DroneSelection --mpheno 1 --pheno DronePhenoHB.txt --noweb --allow-no-sex --within PopClusters.txt  --mh --adjust --out DRONECluster













	









